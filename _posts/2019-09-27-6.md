---
layout: post
title: docker에서 jenkins
category: etc
tags:
  - content
  - jenkins
---

도커에서 jenkins를 실행시켜보자.

## Docker Images Download & Container Run

```bash
docker run -p 2134:8080 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
docker run -d -p 2134:8080 jenkins/jenkins:lts

...
...

*************************************************************
Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

39d061fb9598441780d306e30e38ab42  # 이건 최초 접근 key

This may also be found at: /var/jenkins_home/secrets/initialAdminPassword

*************************************************************
```

뒤에 :lts(Long Term Support : 장기 지원 버전)안 붙이면 jenkins 접근 했을 경우 plugin이 다운되지않는 경우가 발생할 수 있다.

```bash
docker logs jenkins
```

만약 최초 key가 나오지 않는다면 위와 같은 커맨드를 치면 된다.

```bash
[root@ip-000.00.00.000 centos]> docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                               NAMES
cfe1177ab938        jenkins/jenkins:lts   "/sbin/tini -- /us..."   2 days ago          Up 2 days           50000/tcp, 0.0.0.0:2134->8080/tcp   boring_joliot

```

접근해보자

```url
http://ip.ip.ip.ip:2134/
```

크롬으로 본인 ip를 통해 접근하면 최초 key를 입력하라는 창이 뜬다.

위에 뜬거 입력하면 된다.

## Configuration

### Global Tool Configuration

#### jdk 설정

| Name | JAVA_HOME            |
| ---- | -------------------- |
| jdk  | /usr/local/openjdk-8 |

#### Git

| Name    | Path to Git executable |
| ------- | ---------------------- |
| Default | git                    |

#### Maven

☑ Install from Apache : version 선택

### System 설정

### Jenkins Location

#### Jenkins URL

```
http://ip.ip.ip.ip:2134/
```

이곳 주소

#### Github Server

| Name | API URL                | Credentials |
| ---- | ---------------------- | ----------- |
| git  | https://api.github.com | `add`       |

##### add 할때

Settings > Developer settings > Personal access tokens

- Generate new token  
   ☑ repo  
   ☑ admin:repo_hook

## New Item

새로운 프로젝트를 생성한다.

### 1. General

☑ git hub project

- Project Url  
  https://github.com/Ryeom/test01/

### 2. 소스코드 관리

☑ Git

- Repositories  
  https://github.com/Ryeom/test01.git
- Credntials  
  add >  
  git repository > web hooks > add > key 복사

| Domain | Kind        | Scope  | Secret | ID       | Description |
| ------ | ----------- | ------ | ------ | -------- | ----------- |
| global | secret text | global | key    | 부를이름 | 설명        |

### 3. 빌드 유발

☑ GitHub hook trigger for GITScm polling

### 4. 빌드 환경

x

### 5. Build

| Maven Version | Goals                 |
| ------------- | --------------------- |
| maven         | clean package install |

고급 > POM > pom.xml

### 6. 빌드 후 조치

빌드에 성공한다면 배포하도록 설정할 것이다.

plugin 다운 > Deploy to container
|설정 해줘야댐||
|---|---|
|WER/EAR files| `**/*.war`|
|Context path|`/`|
|Containers |`Tomcat 9.x Remote` |

이렇게 하고 톰캣 컨테이너와 연결해야한다.

| Tomcat 9.x Remote |                             |
| ----------------- | --------------------------- |
| Credentials       | `add` id,pw 작성            |
| Tomcat Url        | 컨테이너와 연결되어있는 URL |

`add` > 톰캣 매니저 접근시 아디비번

## Tomcat Container Run

```bash
docker pull tomcat:9
docker ps -a
docker run -d -p 8080:8080 --name tomcat9 tomcat:9

# 실행시키고
docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                               NAMES
b453237316df        tomcat:9              "catalina.sh run"        21 seconds ago      Up 20 seconds       0.0.0.0:8080->8080/tcp              tomcat9
cfe1177ab938        jenkins/jenkins:lts   "/sbin/tini -- /us..."   About an hour ago   Up About an hour    50000/tcp, 0.0.0.0:2134->8080/tcp   boring_joliot

# 접근
docker exec -it b4 /bin/bash
```

일단 접근을 한다. 그안에서 해야할 작업이 있다.

```bash
apt-get update
apt-get upgrade
apt-get install vim       # vim 다운받앙

cd /usr/local/tomcat/conf # 여기로가서
vim tomcat-users.xml
```

tomcat-users.xml 이 파일을 수정해야 한다.

```xml
<role rolename="manager-gui"/>
<role rolename="manager-script"/>
<role rolename="manager-jmx"/>
<role rolename="manager-status"/>
<role rolename="admin-gui"/>
<role rolename="admin-script"/>
<user username="admin" password="admin"
roles="manager-gui,manager-script,manager-jmx,manager-status,admin-gui,admin-script"/>
```

위를 추가해줘야한다.

```bash
cd /usr/local/tomcat/webapps    # 여기 경로로 가서

rm -rf ROOT                     # ROOT 지워버랴

cd /usr/local/tomcat/webapps/manager/META-INF
vim context.xml
```

context.xml에 가보면 value가 있다.

그거 주석 잡아준다.

```bash
docker restart tomcat9
```

안에 xml파일을 수정하면 항상 restart 해야한다.
