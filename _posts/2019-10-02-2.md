---
layout: post
title: Docker File을 만들어 보자
category: etc
tags:
  - content
---

## Docker file의 구성

일단 Docker File이 어떻게 구성되어 있는지 확인하자.

현재 실습 환경은 AWS EC2의 <u>centos7</u>으로 진행하며 instance접근은 mobaXterm으로 진행했다.

이 글은 Docker에 대한 대략적인 지식을 기반으로 한다.

[Docker Hub의 tomcat](https://hub.docker.com/_/tomcat)에 접근하자

lates를 검색하면

From openhdk:8-jdk를 DockerHub에서 Offitical image로 검색한다.

검색해도 8-jdk가 보이지 않는다면 찾아라

[docker-library/tomcat](https://github.com/docker-library/tomcat/blob/d52ac18aaed6fcd6b13177d3bd557bea2ce6d608/8.5/jdk8/openjdk/Dockerfile) 타고  
[openjdk/8/jdk/Dockerfile](https://github.com/docker-library/openjdk/blob/451e66427f3c53fada288aaff950617c5864745f/8/jdk/Dockerfile) 타고  
[buildpack-deps/stretch/scm/Dockerfile](https://github.com/docker-library/buildpack-deps/blob/1845b3f918f69b4c97912b0d4d68a5658458e84f/stretch/scm/Dockerfile) 타고  
[buildpack-deps/stretch/curl/Dockerfile](https://github.com/docker-library/buildpack-deps/blob/b0fc01aa5e3aed6820d8fed6f3301e0542fbeb36/stretch/curl/Dockerfile) 타고  
[docker-debian-artifacts/stretch/Dockerfile](https://github.com/debuerreotype/docker-debian-artifacts/blob/74e1a3304401c2eb9c6624ae1056d0a438c15189/stretch/Dockerfile) 여깅!

마지막 Docker Debian Artifacts의 stretch에 가보면

```Dockerfile
FROM scratch
```

[scratch](https://hub.docker.com/_/scratch)(공CD)라는 문구를 볼 수 있다.

## Server 초기 Setting 짭.ver

war file을 이용한 web server가 필요하다면 <u>centos에서 jdk를 환경변수로 잡고 tomcat을 설치한다</u>

[tomcat](https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.9/bin/)과 [jdk](https://www.oracle.com/technetwork/java/javase/downloads/jdk12-downloads-5295953.html)가 필요하다.

각각 받은 tar.gz는 편하게 사용하기 위해서 tomcat과 java라는 이름으로 변경한다.

그라면 Docker에 [centos7](https://hub.docker.com/_/centos?tab=description)를 설치하자

```bash
docker run <옵션> <이미지 이름 or ID> <명령> <매개변수>
docker run --name centos centos:centos7
docker ps -a
```

### Container에 File 복사

```bash
docker cp <로컬파일 명> <컨테이너 이름 or ID>:<컨테이너 안 복사할 위치>
docker cp tomcat.gz "ID":/usr/local
docker cp java.gz "ID":/usr/local
```

### 컨테이너에 명령어 전달

```bash
docker exec "ID" tar zxvf /usr/local/tomcat.gz
```

이 단계에서 `docker ps -a`를 하면 컨테이너가 Exited되어있는것을 확인할 수 있다.

심지어 `docker start`를 해도 계속해서 Up상태로 되지 않는다.

Docker의 Container는 Virtual Machine이 아니다.

명령어를 주면 실행을 <u>한번만</u> 할 뿐 계속 켜져있는 시스템이 아니다.

[참고](https://www.popit.kr/%EA%B0%9C%EB%B0%9C%EC%9E%90%EA%B0%80-%EC%B2%98%EC%9D%8C-docker-%EC%A0%91%ED%95%A0%EB%95%8C-%EC%98%A4%EB%8A%94-%EB%A9%98%EB%B6%95-%EB%AA%87%EA%B0%80%EC%A7%80/)

우리는 일단 centos에 file을 넣고 압출을 풀고 setting을 하기위해 켜놓을 필요가 있다.

```bash
docker rm <id>
```

## Server 초기 Settiong 찐.ver

컨테이너를 다시 만들자

```bash
docker run -d -t --name base centos:centos7
docker ps -a
```

-d -t -i가 헷갈리거나 정확히 알고 싶으면

```bash
docker run tomcat
docker run -d tomcat
docker run -i tomcat
docker run -t tomcat
docker run -it tomcat
docker run -i centos
docker run -t centos
```

이거 실행 해 보기

파일을 복사.

```bash
docker cp tomcat.gz base:/
docker cp java.gz base:/
```

### 명령어 전달 -압축풀기

```bash
docker exec base tar zxvf tomcat.gz -C /usr/local/
docker exec -d base tar zxvf java.gz -C /usr/local/
```

### Container 내부 진입 및 확인

```bash
docker exec -it base /bin/bash
ls -l
rm -rf java.gz tomcat.gz
cd /usr/local
ls -l
```

### 폴더명 변경

```bash
mv apache-tomcat-8.5.9/ ./tomcat
mv jdk-12.0.2/ ./java
ls -l
```

### Container image화 시키기

바로 실행하고 싶어도 base Container를 만들 때 port forwarding을 하지않았다.

```bash
docker commit -a "~~~" -m " msg " base ~~~/~~~:~~~
docker commit -a "coo <sadb0101@naver.com>" -m "centos - jdk - tomcat base" base ryeom/base:0.0.1
```

### 만든 image를 다시 Container로

```bash
docker run <옵션> <이미지 이름 or ID> <명령> <매개변수>
docker run -itp 8888:8080 --name test1 ryeom/base:0.0.1 /bin/bash
```

## 확인 작업

### 확인 1번

```bash
cd /usr/local/tomcat/bin
./startup.sh
```

JAVA_HOME이 없다고 Error

```bash
export JAVA_HOME=/usr/local/java/
./startup.sh
```

port로 접속해서 tomcat화면이 뜨는가 확인ㄱ
exit하고 접속 끊긴 것 확인ㄱ

```bash
docker ps -a
```

Exited!

### 확인 2번

```bash
docker run -itp 8888:8080 --name test2 sadb0101/base:0.0.1 /bin/bash
export JAVA_HOME=/usr/local/java/
/usr/local/tomcat/bin/catalina.sh run
```

`ctrl + p + q`로 out(exit 명령어의 command .ver)

port로 접속해서 tomcat화면이 뜨는가 확인ㄱ

```bash
docker stop test2
```

접속 끊긴 것을 확인한다.

### 확인 3번

```bash
docker run -tdp 8888:8080 --name test3 sadb0101/base:0.0.1
docker exec test3 /bin/bash -c "export JAVA_HOME=/usr/local/java/"
docker exec test3 /bin/bash -c "/usr/local/tomcat/bin/catalina.sh run"
```

설정해둔 JAVA_HOME이 없다고 뜬다.

```bash
docker exec test3 /bin/bash -c "export JAVA_HOME=/usr/local/java/ && /usr/local/tomcat/bin/catalina.sh run"   # ctrl + z
docker ps -a                            # 접속확인


docker stop test3
docker start test3
docker ps -a                            #접속 확인

docker exec -d test3 /bin/bash -c "export JAVA_HOME=/usr/local/java/ && /usr/local/tomcat/bin/catalina.sh run"    #접속 확인
```

3번의 확인작업을 통해서

1. 환경변수 설정과 실행파일을 실행하기 위해서 쳐야하는 커맨드가 너무 많다.
2. 우린 실행만 하면 자동으로 다 되는 그런걸 원한다.

## ☝ 두가지 방법

### 1. Official tomcat을 받아서 사용

### 2. Dockerfile을 만들어서 직접 Setting

## Docker File 만들기

우리가 지금 base 컨테이너를 직접적으로 수정했던 command를 모으면 다음과 같다.

```bash
# Outside the Container
docker run -d -t --name base centos:centos7
docker cp tomcat.gz base:/
docker cp java.gz base:/
docker exec base tar zxvf tomcat.gz -C /usr/local/
docker exec -d base tar zxvf java.gz -C /usr/local/

# In a Container
rm -rf java.gz
rm -rf tomcat.gz
cd /usr/local
mv /apache-tomcat-8.5.9/ ./tomcat
mv /jdk-12.0.2/ ./java
export JAVA_HOME=/usr/local/java/
catalina.sh run
```

위의 모은 커맨드를 Docker File에 원큐로 완성시킬끄다.

```bash
vi Dockerfile
```

도커파일을 만든다.

```Dockerfile
FROM centos:centos7             # 베이스 cd를 선택

ADD java.gz /                   # .gz파일추가
ADD tomcat.gz /                 # 자동으로 알집도 풀어주는 착한 명령어

RUN rm -rf java.gz              # .gz파일 삭제
RUN rm -rf tomcat.gz

WORKDIR /usr/local/             # 작업 디렉토리 변경 (편하려고)

# java, tomcat 디렉토리 변경
RUN /bin/bash -c "mv /apache-tomcat-8.5.9/ ./tomcat"
RUN /bin/bash -c "mv /jdk-12.0.2 ./java"

# 환경변수 설정
ENV JAVA_HOME=/usr/local/java
ENV CATALINA_HOME=/usr/local/tomcat
ENV CLASSPATH=.:$JAVA_HOME/lib/tools.jar:$CATALINA_HOME/lib/jsp-api.jar:$CATALINA_HOME/lib/servlet-api.jar
ENV PATH=$PATH:$JAVA_HOME/bin:$CATALINA_HOME/bin

EXPOSE 8080                     # 포트 설정

WORKDIR tomcat/bin/             # 작업 디렉토리 변경

# 컨테이너 run할때 서버를 가동시킬 명령어
CMD ["catalina.sh", "run"]
```

이렇게 쓰고

```bash
:wq
```

저장하고 빠져나온다.

이제 이것을 확인해보자

```bash
docker build -t ryeom/base:0.0.2 .
docker run -dp 8888:8080 ryeom/base:0.0.2
```

잘도라감

낄낄
