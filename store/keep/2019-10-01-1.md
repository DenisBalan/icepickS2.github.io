---
layout: post
title:
category: spring
tags:
  - content
  - spring
excerpt_separator: <!--more-->
---

 <!--more-->

스프링은 다양한 데이터 액세스 기술들로 결합된 데이터 액세스 프레임워크를 제공한다. 스프링은 Persistence Layer Code의 Data Access를 제거한다.

사용자는 low-level의 Data Access를 작업을 할때 편하게 만들 수 있다.

## DAO(Data Access Object) / Repository

Persistence logic이 퍼지는 것을 피하기 위해 Data Access는 해당 Task에 집중된 하나 이상의 Component

interface를 통해 접근하는 접근법은 Repository를 격리시키고 오직 Data Access Method만 interface를 통해서 노출되기 때문에 유연한 애플리케이션 설계를 할 수 있다.

또한 Spring은 JDBC보다 훨씬 다양한 예외 계층을 제공하면서도 어떠한 persistence layer와도 연관성을 갖지 않는다.

### Data Method Template

<u>어떤 절차의 골격을 정의한다.</u>

어떤 절차의 구현 종속적인(implemention-specific) 부분을 특정 인터페이스에 위임한다. interface를 서로 다르게 구현 함으로써 위임된 부분에 특화된 부분을 정의하게 된다.

Spring은 Data Access 절차상에서 고정된 단계와 가변적인 단계를 Template와 Callback이라는 두가지의 별도 class로 분리햇다.

| 저장소 Template                  | 저장소 Callback   |
| :------------------------------- | ----------------- |
| 1.resource준비                   |                   |
| 2.transaction시작                | 3.transaction실행 |
|                                  | 4.Data 반환       |
| 5.transaction commit or Rollback |                   |
| 6.resource close & err handler   |                   |

<u>Template</u> Class는 Data Access의 고정된 부분을 담당.  
<u>Callback</u>은 결과추출등 변환과 같은 내용.

### Data Source Bean을 설정하는 방법

- JDNI(Java Naming and Directory Interface)에 등록된 Data Source
- Connection을 Pooling하는 Data Source
- JDBC Driver를 통해 선언된 Data Source

  > ### Data Source
  >
  > JDBC 명세의 일부면서 일반화된 Connection Factory.
  > DB와 관련된 Connection 정보를 담고 있으며 bean으로 등록하여 인자로 넘겨준다.

### JNDI Data Source 이용

> JNDI(Java Naming and Directory Interface)
> Directory Service에서 제공하는 Data 와 Object를 discover(발견)하고 lookup(참고)하기 위한 JAVA API.
>
> - JAVA Application을 외부 Directory Service에 연결  
>   ex : address database 또는 LDAP 서버

Spring에서는 JNDI에 등록된 Data Source의 referance를 설정하고 이를 Data Source가 필요한 class에 일반 Bean과 동일한 방식으로 Wiring한다.

```java
@Bean	//JNDI에서 DataSource를 검색하기 위해 JndiObjectFactoryBean사용
public JndiObjectFactoryBean jndiDataSource() {
    JndiObjectFactoryBean jndiObjFB = new JndiObjectFactoryBean();
	jndiObjFB.setJndiName("jdbc/test01");		//JNDI에 있는 Resource의 이름
	jndiObjFB.setResourceRef(true);				//Application이 Java Application Server에서 가동되는 경우
	jndiObjFB.setProxyInterface(javax.sql.DataSource.class);
	return jndiObjFB;
}
```

### Pooling 기능이 있는 Data Source 사용하기

> Pooling : 명령 실행 선응을 향상시키는데 사용하는 caching 기술  
> ex : connection pool

Spring이 Pooling기능을 가진 Data Source를 제공하지는 않지만 Open Source가 있음

1. Apache commons DBCP
2. c3p0
3. BoneCP

```java
@Bean	//apache commons DBCP
public BasicDataSource poolingDataSource() {
	BasicDataSource basicDataSource = new BasicDataSource();
	basicDataSource.setDriverClassName("org.h2.Driver");//com.mysql.cj.jdbc.Driver
	basicDataSource.setUrl("jdbc:h2:tcp://localhost/~/~");
	basicDataSource.setUsername("root");
	basicDataSource.setPassword("1234");
	//여기까지가 기본이다
	basicDataSource.setInitialSize(5);//이 pool이 시작될때 생성할 커넥션 수

	return basicDataSource;
}
```

### JDBC Driver 기반 Data Source

Spring은 `org.springframework.jdbc.datasource`package 안에 DataSource Class 제공.

| Data Source                |                                                                                                                                                                    |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| DriverManagerDataSource    | Applicaiton이 connection을 요청 할 때마다 새로운 connection을 반환 DBCP-BasicDataSource와는 달리 DriverManagerDataSource가 공급하는 Connection은 Pooling되지 않음. |
| SimpleDriverDataSource     | OSGi Container와 같은 특정환경에서 발생할 수 있는 Class Loading문제를 극복하기 위해 JDBC Driver를 사용하는 경우를 제외하면 DriverManagerData와 거의 동일.          |
| SingleConnectionDataSource | connection을 요청하면 항상 동일한 connection을 반환. 정확히 말해 이것은 Pooling기능은 없지만 오직 한 Connection만을 Pooling하는 Data Source.                       |

```java

```
